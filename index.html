<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AR Human Talk</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <!-- AR.js -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <!-- ðŸ”Š Auto Mouth (Ð´ÑƒÑƒ Ð´Ð°Ð³Ð°ÑÐ°Ð½ Ð°Ð¼ Ñ…Ó©Ð´Ó©Ð»Ð³Ó©Ó©Ð½) -->
  <script>
    AFRAME.registerComponent("auto-mouth", {
      init: function () {
        const el = this.el;
        const audio = document.getElementById("voiceAudio");

        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = ctx.createAnalyser();
        const source = ctx.createMediaElementSource(audio);

        source.connect(analyser);
        analyser.connect(ctx.destination);

        const data = new Uint8Array(analyser.frequencyBinCount);

        this.tick = function () {
          analyser.getByteFrequencyData(data);
          let volume = data.reduce((a, b) => a + b, 0) / data.length;
          let mouth = Math.min(volume / 80, 1);

          el.object3D.traverse((node) => {
            if (node.morphTargetInfluences) {
              node.morphTargetInfluences[0] = mouth;
            }
          });
        };
      }
    });
  </script>
</head>

<body style="margin:0; overflow:hidden;">

  <!-- â–¶ Play / Stop Ñ‚Ð¾Ð²Ñ‡ -->
  <button id="playBtn"
    style="position:absolute; top:20px; left:20px; z-index:999; padding:10px 20px;">
    â–¶ Start
  </button>

  <!-- ðŸŽ§ Audio (control ÑÐ½Ð´ÑÑÑ ÑÐ²Ð½Ð°) -->
  <audio id="voiceAudio" src="voice.mp3"></audio>

  <a-scene
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    vr-mode-ui="enabled:false">

    <!-- 3D Ð¥Ò¯Ð½ -->
    <a-entity id="human"
      gltf-model="human.glb"
      position="0 0.8 -1.5"
      rotation="0 -90 0"
      scale="1.5 1.5 1.5"
      auto-mouth
      look-at="[camera]">
    </a-entity>

    <a-camera position="0 1.6 0"></a-camera>
  </a-scene>

  <script>
    const playBtn = document.getElementById("playBtn");
    const audio = document.getElementById("voiceAudio");

    let isPlaying = false;

    playBtn.addEventListener("click", async () => {
      if (!isPlaying) {
        await audio.play();
        playBtn.textContent = "â¸ Stop";
        isPlaying = true;
      } else {
        audio.pause();
        audio.currentTime = 0;
        playBtn.textContent = "â–¶ Start";
        isPlaying = false;
      }
    });

    audio.onended = () => {
      playBtn.textContent = "â–¶ Start";
      isPlaying = false;
    };
    <audio id="voiceAudio" src="voice.mp3" controls></audio>

  </script>

</body>
</html>
