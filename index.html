<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>WebAR Lip-Sync Avatar</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

    <!-- Lip-sync component -->
    <script>
      AFRAME.registerComponent("auto-mouth", {
        init: function () {
          const el = this.el;
          const audio = document.getElementById("voiceAudio");

          const AudioContext = window.AudioContext || window.webkitAudioContext;
          const ctx = new AudioContext();

          // Audio-г товч дарахад идэвхжүүлэх
          document.getElementById("playBtn").addEventListener("click", () => {
            if (ctx.state === "suspended") {
              ctx.resume();
            }
          });

          const analyser = ctx.createAnalyser();
          const source = ctx.createMediaElementSource(audio);

          source.connect(analyser);
          analyser.connect(ctx.destination);

          const data = new Uint8Array(analyser.frequencyBinCount);

          this.tick = function () {
            analyser.getByteFrequencyData(data);
            let volume = data.reduce((a, b) => a + b, 0) / data.length;
            let mouth = Math.min(volume / 70, 1);

            el.object3D.traverse((node) => {
              if (node.morphTargetInfluences) {
                node.morphTargetInfluences[0] = mouth;
              }
            });
          };
        }
      });
    </script>
  </head>

  <body>
    <h2>WebAR Lip-Sync Avatar</h2>

    <!-- Audio -->
    <audio id="voiceAudio" src="voice.mp3" preload="auto"></audio>

    <!-- Play Button -->
    <button id="playBtn">Start</button>

    <script>
      const playBtn = document.getElementById("playBtn");
      const audio = document.getElementById("voiceAudio");
      let isPlaying = false;

      playBtn.addEventListener("click", async () => {
        if (!isPlaying) {
          await audio.play();
          playBtn.textContent = "Stop";
          isPlaying = true;
        } else {
          audio.pause();
          audio.currentTime = 0;
          playBtn.textContent = "Start";
          isPlaying = false;
        }
      });
    </script>

    <!-- A-Frame Scene -->
    <a-scene background="color: #ECECEC">
      <a-entity 
        gltf-model="human.glb" 
        position="0 0 -1.5" 
        scale="1.5 1.5 1.5" 
        auto-mouth>
      </a-entity>

      <a-camera position="0 1.6 0"></a-camera>
    </a-scene>
  </body>
</html>
